import pandas as pd

class RollingStandardScaler:
    def __init__(self, window=None, ddof=0):
        self.window = window
        self.ddof = ddof
        self.mean_ = None
        self.std_ = None

    def fit_transform(self, df: pd.DataFrame) -> pd.DataFrame:
        if self.window is None:
            self.mean_ = df.expanding(min_periods=1).mean()
            self.std_ = df.expanding(min_periods=1).std(ddof=self.ddof)
        else:
            self.mean_ = df.rolling(self.window, min_periods=1).mean()
            self.std_ = df.rolling(self.window, min_periods=1).std(ddof=self.ddof)

        return (df - self.mean_) / self.std_

    def inverse_transform(self, df_scaled: pd.DataFrame) -> pd.DataFrame:
        if self.mean_ is None or self.std_ is None:
            raise RuntimeError("Must call fit_transform first")

        # index / columns 对齐是关键
        return df_scaled * self.std_ + self.mean_
